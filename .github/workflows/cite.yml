name: CI

on:
  push:
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  cite-validation:
    name: OGC Cite Validation (Features)
    runs-on: ubuntu-latest

    services:
      db:
        image: docker.io/postgis/postgis
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: ogcapi
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      # cite:
      #   image: docker.io/ogccite/ets-ogcapi-features10
      #   ports:
      #     - 9080:8080

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load
        run: cargo run -p data-loader -- --input data/ne_110m_populated_places.geojson --collection places

      - name: Run
        run: RUNNER_TRACKING_ID="" && cargo run -p cite-service &
        # env:
        #   PUBLIC_URL: "http://host.docker.internal:8484"

      - name: Check running service
        run: |
          until [ \
            "$(curl -s -w '%{http_code}' -o /dev/null "http://localhost:8484/")" \
            -eq 200 ]
          do
            sleep 5
          done
          curl -v http://localhost:8484/collections | jq

      - name: Downgrade click
        run: pip install ogc-cite-runner "click<8.2.0"

      - name: Cite container
        run: docker run --detach --rm --name teamengine --add-host=host.docker.internal:host-gateway --publish 9080:8080 ogccite/teamengine-production:1.0-SNAPSHOT

      - name: Check running container
        run: |
          until [ \
            "$(curl -s -w '%{http_code}' -o /dev/null "http://localhost:9080/teamengine")" \
            -eq 200 ]
            echo $http_code
          do
            sleep 5
          done

      - name: Docker
        run: docker network ls && docker ps

      - name: Validate
        run: ogc-cite-runner execute-test-suite --with-passed --with-failed http://localhost:9080/teamengine ogcapi-features-1.0 --suite-input iut http://localhost:8484
        # uses: OSGEO/ogc-cite-runner@v0.3.0
        # with:
        #   test_suite_identifier: ogcapi-features-1.0
        #   test_session_arguments: iut=http://host.docker.internal:8484
        #   teamengine_url: "http://localhost:9080/teamengine"
        #   teamengine_username: "ogctest"
        #   teamengine_password: "ogctest"
        #   with_failed: "true"
        #   with_skipped: "true"
        #   exit_with_error: "false"
